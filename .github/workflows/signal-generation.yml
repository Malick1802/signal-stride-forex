
name: Automatic Trading Signal Generation

on:
  schedule:
    # Run every 5 minutes during market hours (Monday 00:00 UTC to Friday 22:00 UTC)
    - cron: '*/5 * * * 1-5'
  workflow_dispatch:
    inputs:
      force_generation:
        description: 'Force signal generation regardless of market hours'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-signals:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check Market Hours
      id: market-check
      run: |
        # Get current time in UTC
        current_hour=$(date -u +%H)
        current_day=$(date -u +%u)  # 1=Monday, 7=Sunday
        
        echo "Current UTC hour: $current_hour"
        echo "Current day: $current_day"
        
        # Market is open Monday (1) to Friday (5), roughly 00:00-22:00 UTC
        if [ "$current_day" -ge 1 ] && [ "$current_day" -le 5 ]; then
          if [ "$current_hour" -ge 0 ] && [ "$current_hour" -le 22 ]; then
            echo "market_open=true" >> $GITHUB_OUTPUT
          else
            echo "market_open=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "market_open=false" >> $GITHUB_OUTPUT
        fi

    - name: Generate Trading Signals
      if: steps.market-check.outputs.market_open == 'true' || github.event.inputs.force_generation == 'true'
      run: |
        echo "ü§ñ Starting automatic signal generation..."
        
        # Call the existing Supabase edge function
        response=$(curl -s -w "\n%{http_code}" -X POST \
          "https://ugtaodrvbpfeyhdgmisn.supabase.co/functions/v1/generate-signals" \
          -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVndGFvZHJ2YnBmZXloZGdtaXNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQwNjA2MTUsImV4cCI6MjA0OTYzNjYxNX0.Z-71hRCpHB0YivrsTb2kZQdObcF42BQVYIQ8_yMb_JM" \
          -H "Content-Type: application/json" \
          -H "apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVndGFvZHJ2YnBmZXloZGdtaXNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQwNjA2MTUsImV4cCI6MjA0OTYzNjYxNX0.Z-71hRCpHB0YivrsTb2kZQdObcF42BQVYIQ8_yMb_JM" \
          -d '{"trigger": "cron"}')
        
        # Extract HTTP status code (last line)
        http_code=$(echo "$response" | tail -n1)
        # Extract response body (all lines except last)
        response_body=$(echo "$response" | head -n -1)
        
        echo "HTTP Status: $http_code"
        echo "Response: $response_body"
        
        if [ "$http_code" -eq 200 ]; then
          echo "‚úÖ Signal generation successful"
        else
          echo "‚ùå Signal generation failed with status $http_code"
          exit 1
        fi

    - name: Update Market Data
      if: steps.market-check.outputs.market_open == 'true' || github.event.inputs.force_generation == 'true'
      run: |
        echo "üìä Updating centralized market data..."
        
        # Call the market stream function
        response=$(curl -s -w "\n%{http_code}" -X POST \
          "https://ugtaodrvbpfeyhdgmisn.supabase.co/functions/v1/centralized-market-stream" \
          -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVndGFvZHJ2YnBmZXloZGdtaXNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQwNjA2MTUsImV4cCI6MjA0OTYzNjYxNX0.Z-71hRCpHB0YivrsTb2kZQdObcF42BQVYIQ8_yMb_JM" \
          -H "Content-Type: application/json" \
          -H "apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVndGFvZHJ2YnBmZXloZGdtaXNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQwNjA2MTUsImV4cCI6MjA0OTYzNjYxNX0.Z-71hRCpHB0YivrsTb2kZQdObcF42BQVYIQ8_yMb_JM")
        
        # Extract HTTP status code (last line)
        http_code=$(echo "$response" | tail -n1)
        # Extract response body (all lines except last)
        response_body=$(echo "$response" | head -n -1)
        
        echo "HTTP Status: $http_code"
        echo "Response: $response_body"
        
        if [ "$http_code" -eq 200 ]; then
          echo "‚úÖ Market data update successful"
        else
          echo "‚ö†Ô∏è Market data update failed with status $http_code (continuing...)"
        fi

    - name: Market Closed Notice
      if: steps.market-check.outputs.market_open == 'false' && github.event.inputs.force_generation != 'true'
      run: |
        echo "üõë Market is currently closed. Skipping signal generation."
        echo "Automatic generation will resume during market hours (Monday-Friday, 00:00-22:00 UTC)"
